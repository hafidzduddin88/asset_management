name: Cleanup

on:
  schedule:
    - cron: '0 17 * * *' # Daily at 00:00 WIB
  workflow_dispatch:

jobs:
  cleanup:
    runs-on: ubuntu-latest
    permissions:
      actions: write
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Clear GitHub Actions cache
        run: |
          echo "Clearing old caches with proper permissions..."
          
          # Get all caches
          CACHES=$(curl -s -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
                        -H "Accept: application/vnd.github+json" \
                        -H "X-GitHub-Api-Version: 2022-11-28" \
                        "https://api.github.com/repos/${{ github.repository }}/actions/caches")
          
          # Delete old buildkit caches (keep last 2)
          echo "$CACHES" | jq -r '.actions_caches | map(select(.key | test("buildkit|buildx"))) | .[2:] | .[].id' | while read cache_id; do
            if [ ! -z "$cache_id" ]; then
              echo "Deleting old buildkit cache ID: $cache_id"
              curl -X DELETE \
                   -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
                   -H "Accept: application/vnd.github+json" \
                   -H "X-GitHub-Api-Version: 2022-11-28" \
                   "https://api.github.com/repos/${{ github.repository }}/actions/caches/$cache_id" || true
              sleep 0.5
            fi
          done
          
          echo "Cache cleanup completed"

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Delete old Docker Hub tags
        env:
          REPO: ${{ secrets.DOCKERHUB_USERNAME }}/${{ secrets.DOCKERHUB_PROJECT }}
        run: |
          echo "Fetching tags from $REPO..."
          
          # Get Docker Hub token
          TOKEN=$(curl -s -H "Content-Type: application/json" \
                  -X POST -d '{"username": "${{ secrets.DOCKERHUB_USERNAME }}", "password": "${{ secrets.DOCKERHUB_TOKEN }}"}' \
                  https://hub.docker.com/v2/users/login/ | jq -r .token)
          
          # Get tags (keep latest and last 3 SHA tags)
          TAGS=$(curl -s "https://hub.docker.com/v2/repositories/$REPO/tags?page_size=100" | \
                 jq -r '.results[] | select(.name != "latest") | .name' | \
                 tail -n +4)
          
          # Delete old tags
          for tag in $TAGS; do
            if [ ! -z "$tag" ]; then
              echo "Deleting Docker tag: $tag"
              curl -X DELETE -H "Authorization: JWT $TOKEN" \
                   "https://hub.docker.com/v2/repositories/$REPO/tags/$tag/" || true
              sleep 1
            fi
          done
          
          echo "Docker cleanup completed"