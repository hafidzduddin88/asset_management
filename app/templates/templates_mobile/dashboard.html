{% extends "templates_mobile/layouts/modern_layout.html" %}

{% block title %}Dashboard{% endblock %}

{% block head %}
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .chart-container {
            position: relative;
            height: 200px;
        }
        .stat-card {
            transition: all 0.2s ease;
        }
        .stat-card:active {
            transform: scale(0.98);
        }
    </style>
{% endblock %}

{% block content %}
<!-- Header -->
<div class="bg-gradient-to-r from-blue-600 to-purple-600 rounded-lg p-4 mb-4 text-white">
    <div class="flex items-center justify-between">
        <div>
            <h1 class="text-xl font-bold">Dashboard</h1>
            <p class="text-blue-100 text-sm">Asset Management</p>
        </div>
        <button id="refresh-button" class="p-2 bg-white bg-opacity-20 rounded-lg">
            <i id="refresh-icon" class="fas fa-sync-alt text-white"></i>
        </button>
    </div>
</div>

<!-- Quick Stats -->
<div class="bg-white rounded-lg shadow p-4 mb-4">
    <div class="flex items-center justify-between mb-3">
        <h3 class="font-semibold text-gray-900">Total Assets</h3>
        <div class="bg-blue-100 p-2 rounded-lg">
            <i class="fas fa-boxes text-blue-600"></i>
        </div>
    </div>
    <div class="text-2xl font-bold text-blue-600 mb-3">{{ total_assets }}</div>
    <div class="space-y-2">
        <div class="flex justify-between items-center p-2 bg-gray-50 rounded">
            <span class="text-xs text-gray-600">Purchase Value:</span>
            <span class="text-xs font-bold text-green-600">Rp {{ "{:,.0f}".format(total_purchase_value) }}</span>
        </div>
        <div class="flex justify-between items-center p-2 bg-orange-50 rounded">
            <span class="text-xs text-gray-600">Depreciation:</span>
            <span class="text-xs font-bold text-orange-600">Rp {{ "{:,.0f}".format(total_depreciation_value) }}</span>
        </div>
        <div class="flex justify-between items-center p-2 bg-blue-50 rounded">
            <span class="text-xs text-gray-600">Book Value:</span>
            <span class="text-xs font-bold text-blue-600">Rp {{ "{:,.0f}".format(total_book_value) }}</span>
        </div>
    </div>
</div>

<!-- Categories -->
<div class="bg-white rounded-lg shadow p-4 mb-4">
    <div class="flex items-center justify-between mb-3">
        <h3 class="font-semibold text-gray-900">Categories</h3>
        <i class="fas fa-tags text-gray-400"></i>
    </div>
    <div class="space-y-2">
        {% for category, count in category_counts.items() %}
        <div class="flex justify-between items-center py-2">
            <span class="text-sm text-gray-700 truncate">{{ category }}</span>
            <span class="bg-green-100 text-green-800 px-2 py-1 rounded-full text-xs font-medium">{{ count }}</span>
        </div>
        {% endfor %}
    </div>
</div>

<!-- Locations -->
<div class="bg-white rounded-lg shadow p-4 mb-4">
    <div class="flex items-center justify-between mb-3">
        <h3 class="font-semibold text-gray-900">Locations</h3>
        <i class="fas fa-map-marker-alt text-gray-400"></i>
    </div>
    <div class="space-y-2">
        {% for location, count in location_counts.items() %}
        <div class="flex justify-between items-center py-2">
            <span class="text-sm text-gray-700 truncate">{{ location }}</span>
            <span class="bg-purple-100 text-purple-800 px-2 py-1 rounded-full text-xs font-medium">{{ count }}</span>
        </div>
        {% endfor %}
    </div>
</div>

<!-- Chart Section -->
<div class="bg-white rounded-lg shadow p-4 mb-4">
    <div class="flex items-center justify-between mb-4">
        <h3 class="font-semibold text-gray-900">Asset Additions</h3>
        <select id="chartPeriod" class="text-xs px-2 py-1 border border-gray-300 rounded">
            <option value="month">Monthly</option>
            <option value="quarter">Quarterly</option>
            <option value="year">Yearly</option>
        </select>
    </div>
    <div class="chart-container">
        <canvas id="mobileChart"></canvas>
    </div>
</div>

<!-- Activity Summary -->
<div class="grid grid-cols-2 gap-3 mb-4">
    <div class="bg-white rounded-lg shadow p-4">
        <div class="text-center">
            <div class="bg-red-100 p-2 rounded-lg inline-block mb-2">
                <i class="fas fa-exclamation-triangle text-red-600"></i>
            </div>
            <div class="text-lg font-bold text-gray-900">{{ activity_data.get('damaged', {}).get('monthly', {}).values() | sum if activity_data.get('damaged') else 0 }}</div>
            <div class="text-xs text-gray-500">Damaged</div>
        </div>
    </div>
    
    <div class="bg-white rounded-lg shadow p-4">
        <div class="text-center">
            <div class="bg-green-100 p-2 rounded-lg inline-block mb-2">
                <i class="fas fa-wrench text-green-600"></i>
            </div>
            <div class="text-lg font-bold text-gray-900">{{ activity_data.get('repaired', {}).get('monthly', {}).values() | sum if activity_data.get('repaired') else 0 }}</div>
            <div class="text-xs text-gray-500">Repaired</div>
        </div>
    </div>
</div>

<!-- Recent Assets -->
<div class="bg-white rounded-lg shadow p-4 mb-4">
    <div class="flex items-center justify-between mb-3">
        <h3 class="font-semibold text-gray-900">Recent Assets</h3>
        <a href="/assets" class="text-blue-600 text-sm font-medium">View All</a>
    </div>
    <div class="space-y-2">
        {% for asset in latest_assets[:5] %}
        <div class="flex items-center py-2 border-b border-gray-100 last:border-b-0">
            <div class="bg-blue-100 p-1.5 rounded-lg flex-shrink-0">
                <i class="fas fa-box text-blue-600 text-xs"></i>
            </div>
            <div class="ml-2 flex-1 min-w-0">
                <div class="text-xs font-medium text-gray-900 truncate">{{ asset.get("display_name", "Unnamed Asset") }}</div>
                <div class="text-xs text-gray-500 truncate">{{ asset.get("category_display", "") }}</div>
            </div>
            <div class="flex-shrink-0 ml-2">
                {% set status = asset.get("status", "") %}
                {% if status == "Active" %}
                    <span class="px-1.5 py-0.5 text-xs rounded-full bg-green-100 text-green-800 whitespace-nowrap">Active</span>
                {% elif status == "Under Repair" %}
                    <span class="px-1.5 py-0.5 text-xs rounded-full bg-red-100 text-red-800 whitespace-nowrap">Repair</span>
                {% else %}
                    <span class="px-1.5 py-0.5 text-xs rounded-full bg-gray-100 text-gray-800 whitespace-nowrap">{{ status[:8] }}</span>
                {% endif %}
            </div>
        </div>
        {% endfor %}
    </div>
</div>



{% endblock %}

{% block scripts %}
<script>
    // Chart data
    const chartData = {
        month: {
            labels: {{ monthly_chart_labels | tojson }},
            values: {{ monthly_chart_values | tojson }},
            title: 'Monthly Additions'
        },
        quarter: {
            labels: {{ quarterly_chart_labels | tojson }},
            values: {{ quarterly_chart_values | tojson }},
            title: 'Quarterly Additions'
        },
        year: {
            labels: {{ yearly_chart_labels | tojson }},
            values: {{ yearly_chart_values | tojson }},
            title: 'Yearly Additions'
        }
    };
    
    let currentPeriod = 'month';
    
    // Initialize chart
    const ctx = document.getElementById('mobileChart').getContext('2d');
    window.mobileChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: chartData[currentPeriod].labels,
            datasets: [{
                label: 'Assets',
                data: chartData[currentPeriod].values,
                backgroundColor: 'rgba(59, 130, 246, 0.2)',
                borderColor: 'rgba(59, 130, 246, 1)',
                borderWidth: 2,
                fill: true,
                tension: 0.3
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        precision: 0,
                        font: { size: 10 }
                    }
                },
                x: {
                    ticks: {
                        maxRotation: 45,
                        font: { size: 9 },
                        callback: function(val, index) {
                            // Show fewer labels on mobile
                            return index % 2 === 0 ? this.getLabelForValue(val) : '';
                        }
                    }
                }
            },
            plugins: {
                legend: { display: false }
            }
        }
    });
    
    // Handle period change
    document.getElementById('chartPeriod').addEventListener('change', function() {
        const period = this.value;
        currentPeriod = period;
        window.mobileChart.data.labels = chartData[period].labels;
        window.mobileChart.data.datasets[0].data = chartData[period].values;
        window.mobileChart.update();
    });
    
    // Handle refresh button
    document.getElementById('refresh-button').addEventListener('click', function() {
        const refreshIcon = document.getElementById('refresh-icon');
        refreshIcon.style.animation = 'spin 1s linear infinite';
        
        setTimeout(() => {
            refreshIcon.style.animation = '';
            
            // Show toast notification
            const toast = document.createElement('div');
            toast.className = 'fixed bottom-4 left-4 right-4 bg-green-600 text-white px-4 py-2 rounded-lg shadow-lg z-50';
            toast.innerHTML = '<div class="flex items-center justify-center"><i class="fas fa-check-circle mr-2"></i> Dashboard refreshed</div>';
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.remove();
            }, 2000);
        }, 1000);
    });
</script>
{% endblock %}