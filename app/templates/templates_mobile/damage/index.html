{% extends "templates_mobile/layouts/modern_layout.html" %}

{% block title %}Asset Issues{% endblock %}

{% block content %}
<!-- Header -->
<div class="bg-red-600 rounded-lg p-4 mb-4">
    <h1 class="text-xl font-bold text-white">Asset Issues</h1>
    <p class="text-red-100 text-sm">Report damage, loss, or disposal</p>
</div>

<!-- Quick Actions -->
<div class="grid grid-cols-3 gap-3 mb-4">
    <button onclick="openModal('damage')" class="bg-red-600 text-white rounded-lg p-4 text-center">
        <i class="fas fa-exclamation-triangle text-2xl mb-2"></i>
        <div class="text-sm font-medium">Damage</div>
    </button>
    <button onclick="openModal('lost')" class="bg-orange-600 text-white rounded-lg p-4 text-center">
        <i class="fas fa-search text-2xl mb-2"></i>
        <div class="text-sm font-medium">Lost</div>
    </button>
    <button onclick="openModal('disposal')" class="bg-gray-600 text-white rounded-lg p-4 text-center">
        <i class="fas fa-trash text-2xl mb-2"></i>
        <div class="text-sm font-medium">Disposal</div>
    </button>
</div>

<!-- Asset Search -->
<div class="bg-white rounded-lg shadow p-4 mb-4">
    <h3 class="font-semibold text-gray-900 mb-3">Search Asset</h3>
    <div class="space-y-3">
        <input type="text" id="assetSearch" placeholder="Search by name or ID..." 
               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-primary-500 focus:border-primary-500">
        <div class="grid grid-cols-2 gap-3">
            <select id="locationFilter" class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-primary-500 focus:border-primary-500">
                <option value="">All Locations</option>
            </select>
            <select id="roomFilter" class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-primary-500 focus:border-primary-500" disabled>
                <option value="">All Rooms</option>
            </select>
        </div>
    </div>
    <div id="searchResults" class="mt-3 space-y-2 max-h-96 overflow-y-auto">
        <!-- Search results will appear here -->
    </div>
</div>

<!-- Damage Report Modal -->
<div id="damageModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50" style="display: none;">
    <div class="relative top-4 mx-4 p-4 border shadow-lg rounded-lg bg-white">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-medium text-gray-900">Report Damage</h3>
            <button onclick="closeModal('damage')" class="text-gray-400 hover:text-gray-600">
                <i class="fas fa-times text-xl"></i>
            </button>
        </div>
        <form id="damageForm" class="space-y-4">
            <input type="hidden" id="damageAssetId">
            <div>
                <label class="block text-sm font-medium text-gray-700">Asset Name</label>
                <input type="text" id="damageAssetName" readonly class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-50">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700">Damage Type</label>
                <select id="damageType" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg">
                    <option value="">Select Type</option>
                    <option value="Physical">Physical</option>
                    <option value="Electrical">Electrical</option>
                    <option value="Software">Software</option>
                    <option value="Other">Other</option>
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700">Severity</label>
                <select id="damageSeverity" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg">
                    <option value="">Select Severity</option>
                    <option value="Low">Low</option>
                    <option value="Medium">Medium</option>
                    <option value="High">High</option>
                    <option value="Critical">Critical</option>
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700">Description</label>
                <textarea id="damageDescription" required rows="3" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg"></textarea>
            </div>
            <div class="flex space-x-3">
                <button type="button" onclick="closeModal('damage')" class="flex-1 bg-gray-300 py-2 px-4 rounded-lg text-gray-700 font-medium">Cancel</button>
                <button type="submit" class="flex-1 bg-red-600 hover:bg-red-700 py-2 px-4 rounded-lg text-white font-medium">Submit Report</button>
            </div>
        </form>
    </div>
</div>

<!-- Lost Report Modal -->
<div id="lostModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50" style="display: none;">
    <div class="relative top-4 mx-4 p-4 border shadow-lg rounded-lg bg-white">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-medium text-gray-900">Report Lost Asset</h3>
            <button onclick="closeModal('lost')" class="text-gray-400 hover:text-gray-600">
                <i class="fas fa-times text-xl"></i>
            </button>
        </div>
        <form id="lostForm" class="space-y-4">
            <input type="hidden" id="lostAssetId">
            <div>
                <label class="block text-sm font-medium text-gray-700">Asset Name</label>
                <input type="text" id="lostAssetName" readonly class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-50">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700">Date Lost</label>
                <input type="date" id="dateLost" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700">Description</label>
                <textarea id="lostDescription" required rows="3" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg"></textarea>
            </div>
            <div class="flex space-x-3">
                <button type="button" onclick="closeModal('lost')" class="flex-1 bg-gray-300 py-2 px-4 rounded-lg text-gray-700 font-medium">Cancel</button>
                <button type="submit" class="flex-1 bg-orange-600 hover:bg-orange-700 py-2 px-4 rounded-lg text-white font-medium">Submit Report</button>
            </div>
        </form>
    </div>
</div>

<!-- Disposal Request Modal -->
<div id="disposalModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50" style="display: none;">
    <div class="relative top-4 mx-4 p-4 border shadow-lg rounded-lg bg-white">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-medium text-gray-900">Request Disposal</h3>
            <button onclick="closeModal('disposal')" class="text-gray-400 hover:text-gray-600">
                <i class="fas fa-times text-xl"></i>
            </button>
        </div>
        <form id="disposalForm" class="space-y-4">
            <input type="hidden" id="disposalAssetId">
            <div>
                <label class="block text-sm font-medium text-gray-700">Asset Name</label>
                <input type="text" id="disposalAssetName" readonly class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-50">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700">Disposal Reason</label>
                <select id="disposalReason" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg">
                    <option value="">Select Reason</option>
                    <option value="End of Life">End of Life</option>
                    <option value="Irreparable">Irreparable</option>
                    <option value="Obsolete">Obsolete</option>
                    <option value="Other">Other</option>
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700">Description</label>
                <textarea id="disposalDescription" required rows="3" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg"></textarea>
            </div>
            <div class="flex space-x-3">
                <button type="button" onclick="closeModal('disposal')" class="flex-1 bg-gray-300 py-2 px-4 rounded-lg text-gray-700 font-medium">Cancel</button>
                <button type="submit" class="flex-1 bg-gray-600 hover:bg-gray-700 py-2 px-4 rounded-lg text-white font-medium">Submit Request</button>
            </div>
        </form>
    </div>
</div>

<script>
const assetsData = {{ assets_data | tojson }};
let selectedAsset = null;
let roomsData = {};

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    initializeFilters();
    setupEventListeners();
});

function initializeFilters() {
    const locationFilter = document.getElementById('locationFilter');
    
    // Build rooms data and populate locations
    const locations = new Set();
    assetsData.forEach(asset => {
        const location = asset.ref_locations?.location_name || '';
        const room = asset.ref_locations?.room_name || asset.room_name || '';
        
        if (location) {
            locations.add(location);
            if (!roomsData[location]) roomsData[location] = new Set();
            if (room) roomsData[location].add(room);
        }
    });
    
    // Convert sets to arrays
    Object.keys(roomsData).forEach(location => {
        roomsData[location] = Array.from(roomsData[location]).sort();
    });
    
    // Populate location dropdown
    Array.from(locations).sort().forEach(location => {
        const option = document.createElement('option');
        option.value = location;
        option.textContent = location;
        locationFilter.appendChild(option);
    });
}

function setupEventListeners() {
    const locationFilter = document.getElementById('locationFilter');
    const roomFilter = document.getElementById('roomFilter');
    const assetSearch = document.getElementById('assetSearch');
    
    locationFilter.addEventListener('change', function() {
        const selectedLocation = this.value;
        roomFilter.innerHTML = '<option value="">All Rooms</option>';
        roomFilter.disabled = !selectedLocation;
        
        if (selectedLocation && roomsData[selectedLocation]) {
            roomsData[selectedLocation].forEach(room => {
                const option = document.createElement('option');
                option.value = room;
                option.textContent = room;
                roomFilter.appendChild(option);
            });
            roomFilter.disabled = false;
        }
        performSearch();
    });
    
    roomFilter.addEventListener('change', performSearch);
    assetSearch.addEventListener('input', performSearch);
}

function performSearch() {
    const searchTerm = document.getElementById('assetSearch').value.toLowerCase();
    const selectedLocation = document.getElementById('locationFilter').value;
    const selectedRoom = document.getElementById('roomFilter').value;
    const resultsDiv = document.getElementById('searchResults');
    
    if (searchTerm.length < 2 && !selectedLocation && !selectedRoom) {
        resultsDiv.innerHTML = '';
        return;
    }
    
    const filteredAssets = assetsData.filter(asset => {
        const matchesSearch = !searchTerm || searchTerm.length < 2 || 
            asset.asset_name?.toLowerCase().includes(searchTerm) ||
            asset.asset_id?.toString().includes(searchTerm);
        
        const assetLocation = asset.ref_locations?.location_name || '';
        const assetRoom = asset.ref_locations?.room_name || asset.room_name || '';
        
        const matchesLocation = !selectedLocation || assetLocation === selectedLocation;
        const matchesRoom = !selectedRoom || assetRoom === selectedRoom;
        
        return matchesSearch && matchesLocation && matchesRoom;
    });
    
    resultsDiv.innerHTML = filteredAssets.map(asset => {
        const location = asset.ref_locations?.location_name || '';
        const room = asset.ref_locations?.room_name || asset.room_name || '';
        
        return `
            <div class="p-3 border border-gray-200 rounded-lg cursor-pointer hover:bg-gray-50" onclick="selectAsset(${asset.asset_id}, '${asset.asset_name}')">
                <div class="font-medium text-gray-900">${asset.asset_name}</div>
                <div class="text-sm text-gray-500">ID: ${asset.asset_id}</div>
                <div class="text-xs text-gray-400">${location}${room ? ' - ' + room : ''}</div>
            </div>
        `;
    }).join('');
}

function selectAsset(assetId, assetName) {
    selectedAsset = { id: assetId, name: assetName };
    document.getElementById('assetSearch').value = assetName;
    document.getElementById('searchResults').innerHTML = '';
}

function openModal(type) {
    if (!selectedAsset) {
        alert('Please select an asset first');
        return;
    }
    
    document.getElementById(`${type}AssetId`).value = selectedAsset.id;
    document.getElementById(`${type}AssetName`).value = selectedAsset.name;
    document.getElementById(`${type}Modal`).style.display = 'block';
}

function closeModal(type) {
    document.getElementById(`${type}Modal`).style.display = 'none';
}

// Form submissions
document.getElementById('damageForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const formData = {
        asset_id: document.getElementById('damageAssetId').value,
        asset_name: document.getElementById('damageAssetName').value,
        damage_type: document.getElementById('damageType').value,
        severity: document.getElementById('damageSeverity').value,
        damage_description: document.getElementById('damageDescription').value
    };
    
    try {
        const response = await fetch('/report', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(formData)
        });
        
        const result = await response.json();
        alert(result.message);
        
        if (result.status === 'success') {
            closeModal('damage');
            document.getElementById('damageForm').reset();
        }
    } catch (error) {
        alert('Error submitting damage report');
    }
});

document.getElementById('lostForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const formData = {
        asset_id: document.getElementById('lostAssetId').value,
        asset_name: document.getElementById('lostAssetName').value,
        date_lost: document.getElementById('dateLost').value,
        description: document.getElementById('lostDescription').value
    };
    
    try {
        const response = await fetch('/lost', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(formData)
        });
        
        const result = await response.json();
        alert(result.message);
        
        if (result.status === 'success') {
            closeModal('lost');
            document.getElementById('lostForm').reset();
        }
    } catch (error) {
        alert('Error submitting lost report');
    }
});

document.getElementById('disposalForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const formData = {
        asset_id: document.getElementById('disposalAssetId').value,
        asset_name: document.getElementById('disposalAssetName').value,
        disposal_reason: document.getElementById('disposalReason').value,
        description: document.getElementById('disposalDescription').value
    };
    
    try {
        const response = await fetch('/disposal', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(formData)
        });
        
        const result = await response.json();
        alert(result.message);
        
        if (result.status === 'success') {
            closeModal('disposal');
            document.getElementById('disposalForm').reset();
        }
    } catch (error) {
        alert('Error submitting disposal request');
    }
});
</script>
{% endblock %}