name: üî• Cleanup Cache & Docker Images

on:
  workflow_dispatch:  # Manual trigger dari GitHub UI

jobs:
  cleanup:
    runs-on: ubuntu-latest
    env:
      GH_TOKEN: ${{ secrets.PERSONAL_ACCESS_TOKEN }}  # Token personal GitHub
      DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
      DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}
      DOCKERHUB_PROJECT: ${{ secrets.DOCKERHUB_PROJECT }}

    steps:
      - name: üßæ Checkout repository (diperlukan oleh GitHub CLI)
        uses: actions/checkout@v4

      - name: üîß Install GitHub CLI
        run: sudo apt-get install -y gh

      - name: üîå Install gh-actions-cache extension
        run: gh extension install actions/gh-actions-cache

      - name: üîê Authenticate GitHub CLI
        run: echo "$GH_TOKEN" | gh auth login --with-token

      - name: üßπ Delete all GitHub Actions caches
        run: |
          echo "Menghapus semua cache GitHub Actions..."
          gh actions-cache list -R ${{ github.repository }} | cut -f 1 | while read -r cache_key; do
            echo "üóëÔ∏è Menghapus cache: $cache_key"
            gh actions-cache delete "$cache_key" -R ${{ github.repository }} --confirm
          done

      - name: üîê Login to Docker Hub
        run: echo "$DOCKERHUB_TOKEN" | docker login -u "$DOCKERHUB_USERNAME" --password-stdin

      - name: üßπ Delete all Docker Hub tags except 'latest'
        run: |
          echo "Mengambil tag Docker Hub selain 'latest'..."
          REPO="${DOCKERHUB_USERNAME}/${DOCKERHUB_PROJECT}"
          TAGS=$(curl -s -u "${DOCKERHUB_USERNAME}:${DOCKERHUB_TOKEN}" \
            "https://hub.docker.com/v2/repositories/${REPO}/tags?page_size=100" | jq -r '.results[].name')

          for tag in $TAGS; do
            if [ "$tag" != "latest" ]; then
              echo "üóëÔ∏è Menghapus tag: $tag"
              curl -s -X DELETE -u "${DOCKERHUB_USERNAME}:${DOCKERHUB_TOKEN}" \
                "https://hub.docker.com/v2/repositories/${REPO}/tags/${tag}/"
            fi
          done
